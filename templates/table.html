{% extends "base.html" %} {% load custom_filters %} {% block content %}
<div id="content-wrapper" class="bg-amber-100/50 shadow-lg">
    <div class="prose">
        <h1 class="drop-shadow-lg">Albion Online Market Data</h1>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4 pl-2">
        <!-- Item Image -->
        <div class="flex justify-center lg:justify-start lg:col-span-1 mt-4">
            <img
                id="item-image"
                src="https://render.albiononline.com/v1/item/T7_MAIN_HOLYSTAFF"
                alt="Item Image"
                class="h-28 w-28"
            />
        </div>
        <!-- Items and Quantity -->
        <div class="col-span-1 lg:col-span-2 space-y-4">
            <div>
                <label for="item-select" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Item:</h4></label
                >
                <select
                    id="item-select"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    {% for key, value in items.items %}
                    <option value="{{ value }}" data-key="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="quantity-select" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Quantity:</h4></label
                >
                <input
                    id="quantity-select"
                    type="number"
                    placeholder="Quantity"
                    class="prose input input-bordered w-full bg-amber-100 shadow-lg"
                    max="1000"
                />
            </div>
        </div>
        <!-- Quality and Station Fee -->
        <div class="col-span-1 lg:col-span-1 space-y-4">
            <div>
                <label for="quality-select" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Quality:</h4></label
                >
                <select
                    id="quality-select"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>Normal</option>
                    <option>Good</option>
                    <option>Outstanding</option>
                    <option>Excellent</option>
                    <option>Masterpiece</option>
                </select>
            </div>
            <div>
                <label for="station-fee" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Station Fee:</h4></label
                >
                <input
                    id="station-fee"
                    type="number"
                    placeholder="0-1000"
                    class="prose input input-bordered w-full bg-amber-100 shadow-lg"
                    max="1000"
                />
            </div>
        </div>
        <!-- Zone and Hideout -->
        <div class="col-span-1 lg:col-span-1 space-y-4">
            <div>
                <label for="zone-select" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Zone Quality:</h4></label
                >
                <select
                    id="zone-select"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                </select>
            </div>
            <div>
                <label for="ho-power" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Hideout Power</h4></label
                >
                <select
                    id="ho-power"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                    <option>9</option>
                </select>
            </div>
        </div>
        <!-- Daily Bonus & Return Rate -->
        <div class="col-span-1 lg:col-span-1 space-y-4">
            <div>
                <label for="daily-bonus" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Daily Bonus:</h4></label
                >
                <select
                    id="daily-bonus"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>None</option>
                    <option>10%</option>
                    <option>20%</option>
                </select>
            </div>
            <div>
                <label for="return-rate" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Return Rate</h4></label
                >
                <input
                    id="return-rate"
                    class="prose input input-bordered select-sm w-full bg-amber-100 shadow-lg"
                    type="number"
                    disabled
                />
            </div>
        </div>
        <!-- Buy Mats & Sell mats -->
        <div class="col-span-1 lg:col-span-1 space-y-4">
            <div>
                <label for="buy-mats" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Buy Mats:</h4></label
                >
                <select
                    id="buy-mats"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>Bridgewatch</option>
                    <option>Fort Sterling</option>
                    <option>Lymhurst</option>
                    <option>Caerleon</option>
                    <option>Martlock</option>
                    <option>Thetford</option>
                </select>
            </div>
            <div>
                <label for="sell-mats" class="prose label drop-shadow-lg"
                    ><h4 class="prose">Sell Mats</h4></label
                >
                <select
                    id="sell-mats"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>Bridgewatch</option>
                    <option>Fort Sterling</option>
                    <option>Lymhurst</option>
                    <option>Caerleon</option>
                    <option>Martlock</option>
                    <option>Thetford</option>
                </select>
            </div>
        </div>
        <div class="col-span-1 lg:col-span-1">
            <label for="city-price-selection" class="prose label drop-shadow-lg"
                    ><h4 class="prose">City to Sell</h4></label
                >
                <select
                    id="city-price-selection"
                    class="prose select select-bordered select-sm w-full bg-amber-100 shadow-lg"
                >
                    <option>Bridgewatch</option>
                    <option>Fort Sterling</option>
                    <option>Lymhurst</option>
                    <option>Caerleon</option>
                    <option>Martlock</option>
                    <option>Thetford</option>
                </select>
            <label for="focus-check" class="prose label drop-shadow-lg mt-12"
                    ><h4 class="prose">Use Focus</h4><input type="checkbox" checked="unchecked" id="focus-check" class="checkbox mr-8 mb-1"/></label
                >
        </div>
        <!-- Search Button -->
        <div class="col-span-1 lg:col-span-2 space-y-4 p-2">
            <button
                type="submit"
                id="search-button"
                class="prose btn btn-xs sm:btn-sm md:btn-md lg:btn-lg bg-amber-100 mt-16"
            >
                Search
            </button>
        </div>
        <!-- City -->
    </div>
    <div class="bg-base-content/10 my-10 h-2"></div>
</div>
<div id="results" class="mt-4"></div>

<script>
    // Pass the items dictionary to JavaScript
    const itemsDict = {{ items|safe }};

    document.addEventListener("DOMContentLoaded", (event) => {
        function updateItemImage() {
            const itemSelect = document.getElementById("item-select");
            const itemImage = document.getElementById("item-image");
            const selectedItemId = itemSelect.value;
            const baseUrl = "https://render.albiononline.com/v1/item/";

            itemImage.src = baseUrl + selectedItemId;
            itemImage.alt = selectedItemId;
            itemImage.title = selectedItemId;
        }

        // Attach the event listener to the select element
        const itemSelect = document.getElementById("item-select");
        itemSelect.addEventListener("change", updateItemImage);

        // Initialize the image with the first item's image
        updateItemImage();

        function updateStationFee() {
            const stationFee = document.getElementById("station-fee");

            if (stationFee.value > 1000) {
                stationFee.value = 1000;
            } else if (stationFee.value < 0) {
                stationFee.value = 0;
            }
        }

        // Attach the event listener to the station fee input element
        const stationFeeInput = document.getElementById("station-fee");
        stationFeeInput.addEventListener("change", updateStationFee);

        // Handle the search button click
        const searchButton = document.getElementById("search-button");
        searchButton.addEventListener("click", async () => {
            const selectedItemId = itemSelect.options[itemSelect.selectedIndex].getAttribute("data-key");
            const qualitySelect = document.getElementById("quality-select");
            const selectedQuality = qualitySelect.value;
            const selectedCity = document.getElementById("city-price-selection").value;
            const qualityToNumber = {
                Normal: 1,
                Good: 2,
                Outstanding: 3,
                Excellent: 4,
                Masterpiece: 5
            };
            const selectedQualityNumber = qualityToNumber[selectedQuality];
            const url = `https://europe.albion-online-data.com/api/v2/stats/prices/T4_${selectedItemId},T5_${selectedItemId},T6_${selectedItemId},T7_${selectedItemId},T8_${selectedItemId}?locations=${selectedCity}&qualities=${selectedQualityNumber}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        });

        function displayResults(data) {
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";

            // Create a table element
            const table = document.createElement("table");
            table.classList.add("table", "table-zebra", "w-full");

            // Create table header
            const thead = document.createElement("thead");
            thead.innerHTML = `
                <tr class="prose">
                    <th>Item ID</th>
                    <th>City</th>
                    <th>Quality</th>
                    <th>Sell Price</th>
                    <th>Buy Price</th>
                    <th>Updated</th>
                </tr>
            `;
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement("tbody");
            const body = document.getElementById("the-body");

            const spacer = document.createElement("div");
            spacer.classList.add("h-20");

            data.forEach(item => {
                // Strip the first three characters from the item ID
                const itemId = item.item_id.toString();
                console.log(itemId)
                const strippedItemId = item.item_id.substring(3);
                const strippedItemTier = item.item_id.substring(0, 2);
                const itemName = itemsDict[strippedItemId];
                const cityHtml = colorizeCity(item.city);
                const qualityHtml = qualityDescription(item.quality);

                const row = document.createElement("tr");
                row.classList.add("prose");
                row.innerHTML = `
                    <td><img src="https://render.albiononline.com/v1/item/${itemId}" alt="${itemId}" title="${itemId}" style="width: 50px; height: 50px; display: block; margin-top: 5px">${strippedItemTier} ${itemName}</td>
                    ${cityHtml}
                    ${qualityHtml}
                    <td>${item.sell_price_min}</td>
                    <td>${item.buy_price_max}</td>
                    <td>${new Date(item.sell_price_min_date).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });

            body.appendChild(spacer);
            table.appendChild(tbody);
            resultsDiv.appendChild(table);
        }

        function colorizeCity(city) {
            const colorMap = {
                'Caerleon': 'darkred',
                'Bridgewatch': 'darkorange',
                'Fort Sterling': 'grey',
                'Lymhurst': 'green',
                'Martlock': 'blue',
                'Thetford': 'purple'
            };
            const color = colorMap[city] || 'black';
            return `<td style="color: ${color};">${city}</td>`;
        }

        function qualityDescription(quality) {
            const qualityMap = {
                '1': ['Normal', ''],
                '2': ['Good', 'color: gray;'],
                '3': ['Outstanding', 'color: saddlebrown;'],
                '4': ['Excellent', 'color: silver;'],
                '5': ['Masterpiece', 'color: goldenrod;']
            };
            const [description, style] = qualityMap[quality] || [quality, ''];
            return `<td style="${style}">${description}</td>`;
        }
    });
</script>
{% endblock content %}